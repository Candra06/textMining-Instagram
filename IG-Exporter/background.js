(()=>{function e(e,t){let r={code:e,message:t};return new Error(JSON.stringify(r))}function t(t){if(200===t.status||t.status>=300&&t.status<400)return t;if(t.status>=400&&t.status<500)throw 404===t.status?e(t.status,"404 Instagram profile url not found"):e(t.status,"Please wait a few minutes before you try again");if(t.status>=500&&t.status<600)throw e(t.status,"Instagram Web Server Error");throw e(t.status,"Fetch Error")}function r(r){return new Promise((async(o,s)=>{(function(t,r){const o=fetch(t,r).catch((t=>{throw e(1001,t.message)})),s=new Promise(((t,r)=>{setTimeout((()=>{r(e(1e3,"Network Timeout"))}),2e4)}));return Promise.race([o,s])})(r).then(t).then((async t=>{const r=await t.text();if(200===t.status)return r;s(e(1002,"Something wrong! Go to Instagram page to verify."))})).then((e=>{o(e)})).catch((e=>{s(e)}))}))}function o(e){return new Promise((t=>setTimeout(t,e)))}let s=0;chrome.runtime.onMessage.addListener((function(t,a,n){return"StartParsing"==t.action?(s=0,async function(t,a){try{const n=function(e){let t={error:"",profileUrl:""};if(""===e)return t.error="Instagram post url can't be empty",t;try{let t=new URL(e);e=t.origin+t.pathname}catch(e){return t.error="This is not a valid IG Post URL",t}return/^https:\/\/(www\.)?instagram\.com\/p\/[a-zA-Z0-9_-]+\/?$/.test(e)?t.profileUrl=e:t.error="This is not a valid IG Post URL",t}(t.user);""!=n.error&&a(e(2003,n.error).message);const i=n.profileUrl.split("/")[4];if(i.length>0){let n=i,c=!0,m="",u=0,d=0,l=(t.mode,"edge_media_to_comment"),f={postUrl:n,mode:(t.mode,"Comments"),items:{}};for(;c&&0===s;){chrome.tabs.sendMessage(t.tab,{action:"inProgress",counter:d,total:u});let i="https://www.instagram.com/graphql/query/?";i+="query_hash="+encodeURIComponent("33ba35852cb50da46f5b5e889df7d159"),i+="&variables="+encodeURIComponent('{"shortcode":"'+n+'","after":"'+m+'","first":50}');const g=await r(i);if("object"!=typeof g&&null!==g&&g.indexOf("profile_pic_url")>=0){const e=JSON.parse(g),t=e.data.shortcode_media[l].edges;c=e.data.shortcode_media[l].page_info.has_next_page,m=e.data.shortcode_media[l].page_info.end_cursor,u=e.data.shortcode_media[l].count,t.forEach((e=>{f.items[d]={comment_id:e.node.id,text:e.node.text,created_at:e.node.created_at.toString(),user_id:e.node.owner.id,username:e.node.owner.username,profile_pic_url:e.node.owner.profile_pic_url},d+=1}))}else a(e(2002,f).message),s=1;for(let e=t.delay;e>=0;e--)if(0===s){if(chrome.tabs.sendMessage(t.tab,{action:"updateCounter",counter:d,total:u,delay:e}),!c)break;await o(1e3)}}a(e(2e3,f).message)}else a(e(2001,"getUserId Error").message)}catch(e){a(e.message)}}(t,n),!0):"StopParsing"==t.action?(s=1,!0):void 0})),chrome.runtime.onInstalled.addListener((e=>{e.reason===chrome.runtime.OnInstalledReason.INSTALL&&chrome.runtime.setUninstallURL("https://docs.google.com/forms/d/e/1FAIpQLSeMAEy6InQRMGpQ1fST-480hTTKtzyQs8gGFDjKmZa86YcKlg/viewform?usp=sf_link")}))})();